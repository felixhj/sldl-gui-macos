name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*' # Trigger on tags like v1.0.0

jobs:
  build-and-release:
    name: Build on ${{ matrix.os }} (${{ matrix.arch }})
    strategy:
      matrix:
        include:
          - os: macos-13 # Ventura for x86_64
            arch: x64
            python-version: '3.9'
          - os: macos-14 # Sonoma for arm64 (Apple Silicon)
            arch: arm64
            python-version: '3.9'

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.arch }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download and Extract slsk-batchdl
        uses: robinraju/release-downloader@v1.9
        with:
          repository: 'fiso64/slsk-batchdl'
          latest: true
          fileName: 'sldl_osx-${{ matrix.arch }}.zip'
          extract: true

      - name: Build the application with PyInstaller
        run: |
          pyinstaller --noconfirm --windowed --name="SoulseekDownloader" \
            --add-binary="sldl_osx-${{ matrix.arch }}/sldl:." \
            --add-data="csv_processor.py:." \
            --icon=icon.icns \
            --codesign-identity="-" \
            soulseek_downloader.py

      - name: Package the application
        run: |
          mkdir -p release
          # The output of PyInstaller is a .app bundle on macOS
          ditto -c -k --sequesterRsrc --keepParent dist/SoulseekDownloader.app release/SoulseekDownloader-macOS-${{ matrix.arch }}.zip

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release/SoulseekDownloader-macOS-${{ matrix.arch }}.zip
          draft: true # Creates a draft release, you can publish it manually
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
